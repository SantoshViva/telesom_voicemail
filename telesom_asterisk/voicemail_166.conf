[from-main-voicemail]
exten => _X.,1,Set(__DID2=${EXTEN:0:3})
;exten => _X.,1,System(echo -e " [ ${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} ] voicemail Incoming Call Received from ${CALLERID(all)} on DID ${EXTEN} in Context ${CONTEXT} CHANNEL = ${CHANNEL} UNIQUEID = ${UNIQUEID} executing voicemail main" >>  /var/lib/asterisk/sounds/en/voicemail/log/asterisk-dialplan.log)
        same => n,Set(__DID=${EXTEN})
        same => n,Set(__BPARTY=${agi_callerid})
	same => n,Set(aparty=${CALLERID(num)})
	same => n,Set(apartynumlen=${LEN(${aparty})})
;	same => n,Set(HistoryInfoHeader1=${SIP_HEADER(History-Info,1)})
;	same => n,Set(HistoryInfoHeader2=${SIP_HEADER(History-Info,2)})
;	same => n,Set(HistoryInfoHeader3=${SIP_HEADER(History-Info,3)})
;	same => n,Set(raw_headers=${SIP_HEADER(RawHeaders)})
;        same => n,System(echo -e " [ ${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} ] 3 VOICE MAILE aparty = ${aparty} |apartynumlen = ${apartynumlen} in Context ${CONTEXT} CHANNEL = ${CHANNEL} UNIQUEID = ${UNIQUEID} DID = ${EXTEN} HistoryInfoHeader1 = ${HistoryInfoHeader1} HistoryInfoHeader2 = ${HistoryInfoHeader2} HistoryInfoHeader3 = ${HistoryInfoHeader3}" >> /var/lib/asterisk/sounds/en/voicemail/log/asterisk-dialplan.log)
 ;       same => n,System(echo -e " [ ${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} ] 3 VOICE MAILE  in Context ${CONTEXT} CHANNEL = ${CHANNEL} UNIQUEID = ${UNIQUEID} DID = ${EXTEN} raw_headers = ${raw_headers}" >>  /var/lib/asterisk/sounds/en/voicemail/log/asterisk-dialplan.log)
  ;      same => n,NoOp(${SIP_HEADER(History-Info)})
   ;     same => n,NoOp(${SIP_HEADER(Co)}, => , ${SIP_HEADER(Contact)}, ${SIP_HEADER(History-Info)})
;same => n,Set(historyDetails=${PJSIP_HEADER(read,History-Info)})
      ;  same => n,Set(HistoryInfoHeader=${SIP_HEADER(History-Info)})
	same => n,Set(vMsisdn=${CUT(CUT(SIP_HEADER(History-Info),@,1),:,2)})
;	same => n,Set(numlen=${LEN(${vMsisdn})})
	same => n,Set(__VMSISDN=${vMsisdn})
;	same => n,Set(last9digits=${SUBSTR(${vMsisdn},${numlen}-9)})
	same => n,Set(vReason=${CUT(CUT(SIP_HEADER(History-Info),&,1),=,2)})
	;same => n,Set(vReason=${REPLACE(vReason,%3B,A)})
	same => n,Set(vReason=${STRREPLACE(vReason,"%3B"," ")})
	same => n,Set(vReason=${STRREPLACE(vReason,"%3D"," ")})
	same => n,Set(vReason=${STRREPLACE(vReason,"%22"," ")})
	same => n,Set(vReason=${STRREPLACE(vReason,"%20"," ")})
;	same => n,Set(diversion=${CHANNEL(History-Info)})
;	same => n,Set(history_info=${CUT(SIP_HEADER(History-Info), ,1)})
;	same => n,NoOp(History-Info header: ${history_info})
	same => n,ExecIf($["${apartynumlen}"="9"]?Set(first_two_digits=${aparty:0:2}))
	same => n,ExecIf($["${apartynumlen}"="10"]?Set(first_two_digits=${aparty:0:3}))
;	same => n,Set(history_info=${HISTORY_INFO()})
;same => n,ExecIf($["${HistoryInfoHeader}"!=""])?Set(CallReason=${CUT(SIP_HEADER(History-Info),reason=,2)}))
 ;       same => n,System(echo -e " [ ${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} ] aparty = ${aparty} |apartynumlen = ${apartynumlen} |first_two_digits = ${first_two_digits}|Context= ${CONTEXT} |CHANNEL = ${CHANNEL} |UNIQUEID = ${UNIQUEID} |DID = ${EXTEN} |HistoryInfoHeader = ${SIP_HEADER(History-Info)} |vMsisdn = ${vMsisdn} |vReason = ${vReason} |VMSISDN = ${VMSISDN} |numlen = ${numlen}|last9digits = ${last9digits}" >>  /var/lib/asterisk/sounds/en/voicemail/log/asterisk-dialplan.log)
       ; same => n,Set(foo=${SIP_HEADER(headername)})
  ;      same => n,Set(DN=${SIP_HEADER(TO):5})
 ;       same => n,Set(DNN=${CUT(DN,@,1)})
   ;     same => n,Set(TESTAT=${CUT(SIP_HEADER(From),@,2)})
    ;    same => n,Set(ViaHeader=${SIP_HEADER(Via)})
 ;       same => n,Set(ToHeader=${SIP_HEADER(To)})
;        same => n,System(echo -e " [ ${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} ] 4 VOICE MAIL  in Context ${CONTEXT} CHANNEL = ${CHANNEL} UNIQUEID = ${UNIQUEID} DID = ${EXTEN} foo =${foo}  DN = ${DN} DNN = ${DNN} TESTAT = ${TESTAT} ViaHeader = ${ViaHeader} |ToHeader = ${ToHeader} |HistoryInfoHeader = ${HistoryInfoHeader}" >>  /var/lib/asterisk/sounds/en/voicemail/log/asterisk-dialplan.log)
        ;same => n,Playback(voicemail/Please_record_message)
	same => n,ExecIf($["${vReason}"="SIP cause 408 text  User No Reply "]?Playback(voicemail/som/Unreachable))
	same => n,ExecIf($["${vReason}"="SIP cause 503 text  Subscriber Not Reachable "]?Playback(voicemail/som/Switchoff))
	same => n,ExecIf($["${vReason}"=" SIP cause 408 text  User No Reply  "]?Playback(voicemail/som/Unreachable))
	same => n,ExecIf($["${vReason}"="SIP cause 302 text  Unconditional "]?Playback(voicemail/som/Unreachable))
	same => n,ExecIf($["${vReason}"="SIP cause 486 text  User Busy "]?Playback(voicemail/som/Busy))
	same => n,ExecIf($["${apartynumlen}"<"9"]?Hangup()
	same => n,ExecIf($["${first_two_digits}"!="63"]?Hangup()
	same => n,ExecIf($["${vMsisdn}"==""]?Hangup()
	same => n,AGI(voicemail_KaafiyaApi.agi)
;	same => n,System(echo -e " [ ${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} ] Balance Check in Context ${CONTEXT} CHANNEL = ${CHANNEL} UNIQUEID = ${UNIQUEID} DID = ${EXTEN} foo =${foo} SUBSCRIBER_STATUS = ${SUBSCRIBER_STATUS}" >>  /var/lib/asterisk/sounds/en/voicemail/log/asterisk-dialplan.log)
	;same => n,ExecIf($["${SUBSCRIBER_STATUS}"="N"]?Playback(voicemail/som/Low_balance1)
	;same => n,ExecIf($["${aparty}"="634097961" ]?Goto(VOICEMAIL_EMERGENCY_EGILIBILITY,${EXTEN},1))
	same => n,ExecIf($["${SUBSCRIBER_STATUS}"="N"]?Hangup()
	same => n,ExecIf($["${SUBSCRIBER_STATUS}"="E"]?Hangup()
	same => n,ExecIf($["${SUBSCRIBER_STATUS}"="-1"]?Hangup()
	same => n,ExecIf($["${SUBSCRIBER_STATUS}"="K"]?Hangup()
        same => n,Set(COUNTER=1)
        same => n,While($[${COUNTER} <= 3])
        same => n,Read(OPT,voicemail/som/Press_1_2_option,1,,1,5)
;        same => n,System(echo -e " [ ${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} ] Recording Option Playing Voice mail Menu option Context ${CONTEXT} CHANNEL = ${CHANNEL} user input OPT = ${OPT}  UNIQUEID = ${UNIQUEID}" >>  /var/lib/asterisk/sounds/en/voicemail/log/asterisk-dialplan.log)
        same => n,ExecIf($["${OPT}"="1"]?Goto(RECORD_VOICE_MESSAGE,${EXTEN},1))
        same => n,ExecIf($["${OPT}"="2"]?Hangup())
        same => n,ExecIf($["${OPT}"=""]?Playback(voicemail/som/No_input))
        same => n,ExecIf($["${OPT}"!=""]?Playback(voicemail/Wrong_press))
        same => n,ExecIf($["${COUNTER}"="3"]?Playback(voicemail/Exceeded_limit))
        same => n,Set(COUNTER=$[${COUNTER} + 1])
same => n,Hangup()
[VOICEMAIL_EMERGENCY_EGILIBILITY]
exten => _X.,1,System(echo -e " [ ${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} ] VOICEMAIL_EMERGENCY_EGILIBILITY context ${CONTEXT} CHANNEL = ${CHANNEL} UNIQUEID = ${UNIQUEID}  aparty = ${aparty} " >>  /var/lib/asterisk/sounds/en/voicemail/log/asterisk-dialplan.log)
	same => n,AGI(emergencyEligiblityCheck.agi)
	same => n,System(echo -e " [ ${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} ] VOICEMAIL_EMERGENCY_EGILIBILITY Context ${CONTEXT} CHANNEL = ${CHANNEL} UNIQUEID = ${UNIQUEID} DID = ${EXTEN} foo =${foo} eligibility_status = ${eligibility_status}  aparty = ${aparty} " >>  /var/lib/asterisk/sounds/en/voicemail/log/asterisk-dialplan.log)
	same => n,ExecIf($["${eligibility_status}"!="ok"]?Hangup()
        same => n,Set(COUNTER=1)
        same => n,While($[${COUNTER} <= 3])
	same => n,Read(OPT,voicemail/som/Welcome_emergency_credit,1,,1,5)
        same => n,ExecIf($["${OPT}"="1"]?Goto(VOICEMAIL_EMERGENCY_CREDIT,${EXTEN},1))
        same => n,ExecIf($["${OPT}"="2"]?Hangup())
        same => n,ExecIf($["${OPT}"=""]?Playback(voicemail/som/No_input))
        same => n,ExecIf($["${OPT}"!=""]?Playback(voicemail/Wrong_press))
        same => n,ExecIf($["${COUNTER}"="3"]?Playback(voicemail/Exceeded_limit))
        same => n,Set(COUNTER=$[${COUNTER} + 1])
same => n,Hangup()	
[VOICEMAIL_EMERGENCY_CREDIT]
exten => _X.,1,System(echo -e " [ ${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} ] VOICEMAIL_EMERGENCY_CREDIT Context ${CONTEXT} CHANNEL = ${CHANNEL} UNIQUEID = ${UNIQUEID} " >>  /var/lib/asterisk/sounds/en/voicemail/log/asterisk-dialplan.log)
        same => n,AGI(emergencyCrdited.agi)
        same => n,System(echo -e " [ ${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} ] VOICEMAIL_EMERGENCY_CREDIT Context ${CONTEXT} CHANNEL = ${CHANNEL} UNIQUEID = ${UNIQUEID} DID = ${EXTEN} foo =${foo} credit_status = ${credit_status}" >>  /var/lib/asterisk/sounds/en/voicemail/log/asterisk-dialplan.log)
	same => n,Playback(voicemail/som/You_successfully_credited)
	same => n,Hangup()	

[RECORD_VOICE_MESSAGE]
exten => _X.,1,System(echo -e " [ ${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} ] RECORD_VOICE_MESSAGE Context ${CONTEXT} CHANNEL = ${CHANNEL} UNIQUEID = ${UNIQUEID} " >>  /var/lib/asterisk/sounds/en/voicemail/log/asterisk-dialplan.log)
        same => n,Playback(voicemail/som/Record_voice_message_beep)
        ;same => n,Playback(chat/Press_hash_to_send)
        ;same => n,Playback(voicemail/som/Beep_voice)
        ;same => n,Wait(1)
        same => n,Set(__CHAT_MESSAGE_PATH=/var/lib/asterisk/sounds/en/voicemail/vm_recordings/voicemail-${UNIQUEID}.wav)
        ;same => n,Set(__CHAT_MESSAGE_PATH=/tmp/voicemail-${UNIQUEID}.wav)
        same => n,Set(__CHAT_DURATION=30000)
        same => n,Record(${CHAT_MESSAGE_PATH},,30,any)
	;same => n,WaitExten(30)
        ;same => n,Record(${CHAT_MESSAGE_PATH},,30)
       ; same => n,Wait(1)
        same => n,Playback(/var/lib/asterisk/sounds/en/voicemail/vm_recordings/voicemail-${UNIQUEID})
        ;same => n,Read(OPT,voicemail/Press_1_to_send,1,,1,5)
;        same => n,System(echo -e " [ ${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} ]Successfull Recording aparty = ${aparty} recording RECORD_VOICE_MESSAGE Playing main menu option Context ${CONTEXT} CHANNEL = ${CHANNEL} user input OPT = ${OPT}  UNIQUEID = ${UNIQUEID} CHAT_MESSAGE_PATH = ${CHAT_MESSAGE_PATH}" >>  /var/lib/asterisk/sounds/en/voicemail/log/asterisk-dialplan.log)
        same => n,AGI(voicemail_RecordMessageApi.agi)
        same => n,Playback(voicemail/som/Thanks_recording_message)
	same => n,System(rm -rf /var/lib/asterisk/sounds/en/voicemail/vm_recordings/voicemail-${UNIQUEID}.wav)
        same => n,Hangup()

[VOICEMAIL_LISTEN_MESSAGE]
exten => _X.,1,System(echo -e " [ ${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} ] 1 VOICEMAIL_LISTEN_MESSAGE Context ${CONTEXT} CHANNEL = ${CHANNEL} UNIQUEID = ${UNIQUEID} CHAT_GROUP_ID = ${CHAT_GROUP_ID} MAX_CHAT_MESSAGES = ${MAX_CHAT_MESSAGES} BLACKLIST_STATUS = ${BLACKLIST_STATUS}" >>  /var/lib/asterisk/sounds/en/voicemail/log/asterisk-dialplan.log)
	same => n,Set(__MAX_CHAT_MESSAGES=50)
        same => n,ExecIf($["${BLACKLIST_STATUS}"="Y"]?Playback(chat/Blacklist_message))
        same => n,ExecIf($["${BLACKLIST_STATUS}"="Y"]?Hangup())
        same => n,set(currHour=${STRFTIME(${EPOCH h},,%H)})
;        same => n,System(echo -e " [ ${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} ] 2 VOICEMAIL_LISTEN_MESSAGE Context ${CONTEXT} CHANNEL = ${CHANNEL} UNIQUEID = ${UNIQUEID} currHour = ${currHour}" >>  /var/lib/asterisk/sounds/en/voicemail/log/asterisk-dialplan.log)

	;same => n,Set( historyInfo = "<sip:619998566@anonymous.invalid?reason=SIP%3Bcause%3D503%3Btext%3D%22Subscriber%20Not%20Reachable%22&Privacy=history>")

 ;       same => n,System(echo -e " [ ${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} ] 3 VOICEMAIL_LISTEN_MESSAGE Context ${CONTEXT} CHANNEL = ${CHANNEL} UNIQUEID = ${UNIQUEID} Info = ${historyInfo}" >>  /var/lib/asterisk/sounds/en/voicemail/log/asterisk-dialplan.log)

        same => n,ExecIf($["${currHour}"<"12"]?Playback(voicemail/Good_morning):ExecIf($["${currHour}"<"17"]?Playback(voicemail/Good_afternoon):Playback(voicemail/Good_evening)))
        same => n,Playback(voicemail/Welcome_voice_mail)
        same => n,Set(__CHAT_MESSAGE_ID=500000)
        same => n,Set(__CALL_DISCONNECT=0)
        same => n,Set(__CHAT_MESSAGE_FINISH=0)
        same => n,Set(COUNTER=1)

        same => n,While($[${COUNTER} <= 5])
;        same => n,System(echo -e " [ ${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} ] VOICEMAIL_LISTEN_MESSAGE Context ${CONTEXT} CHANNEL = ${CHANNEL} user input OPT = ${OPT}  UNIQUEID = ${UNIQUEID} CHAT_MESSAGE_ID = ${CHAT_MESSAGE_ID} CHAT_MESSAGE_FINISH = ${CHAT_MESSAGE_FINISH} TOTAL_CHAT_MESSAGES = ${TOTAL_CHAT_MESSAGES} CALL_DISCONNECT = ${CALL_DISCONNECT}" >>  /var/lib/asterisk/sounds/en/voicemail/log/asterisk-dialplan.log)
	same => n,ExecIf($["${CALL_DISCONNECT}"="#"]?Goto(VOICEMAIL_LISTEN_MESSAGE,${EXTEN},1))
	same => n,ExecIf($["${CALL_DISCONNECT}"="1"]?Hangup()
        same => n,ExecIf($["${CHAT_MESSAGE_FINISH}"="1"]?Playback(voicemail/Sorry_last_message))
        same => n,ExecIf($["${CHAT_MESSAGE_FINISH}"="1"]?Hangup())
        same => n,ExecIf($["${MAX_CHAT_MESSAGES}"="${TOTAL_CHAT_MESSAGES}"]?Playback(voicemail/Sorry_last_message))
        same => n,ExecIf($["${MAX_CHAT_MESSAGES}"="${TOTAL_CHAT_MESSAGES}"]?Hangup())
        same => n,AGI(voicemail_fetchMessages.agi)
        same => n,Set(COUNTER=$[${COUNTER} + 1])
        same => n,EndWhile()
same => n,Hangup()
